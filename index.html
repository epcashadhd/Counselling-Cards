<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>生活感受卡</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <style>
        @import url('https://fonts.googleapis.com/earlyaccess/cwtexyen.css');
    </style>
    
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600&display=swap" rel="stylesheet">

    <style>
        /* --- Base Settings --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: "cwTeXYen", "PingFang TC", "Microsoft JhengHei", sans-serif;
            background-color: #f9f9f9;
            overscroll-behavior: none;
            touch-action: none; 
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        img {
            -webkit-user-drag: none; 
            user-drag: none;
            pointer-events: auto; 
            outline: 1px solid transparent;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform: translateZ(0);
            image-rendering: -webkit-optimize-contrast; 
        }

        /* --- 0. Preloader --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #4fc3f7;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        .loading-text { color: #888; font-weight: bold; font-size: 1.2rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Global Scaler --- */
        #scalable-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform-origin: top left; overflow: hidden;
        }

        /* --- 1. Start Screen --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 999; transition: opacity 0.8s ease-in-out; opacity: 0;
        }
        .instruction-text {
            /* [調整] 字體加大 1.6rem -> 1.9rem */
            font-size: 1.9rem; 
            color: #4a4a4a; text-align: center; line-height: 2;
            margin-bottom: 50px; padding: 0 40px; max-width: 900px; font-weight: 700;
            letter-spacing: 1px; opacity: 0; animation: fadeInText 1s ease-out forwards;
        }
        .highlight-blue { color: #4fc3f7; }
        .highlight-grey { color: #9e9e9e; }
        @keyframes fadeInText { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInBtn { from { opacity: 0; } to { opacity: 1; } }

        .start-btn-img {
            width: 220px; cursor: pointer; 
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.2s ease; 
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.1)); opacity: 0;
            animation: fadeInBtn 1s ease-out 0.3s forwards;
        }
        .start-btn-img:hover { transform: scale(1.08) translateZ(0); filter: drop-shadow(0 8px 15px rgba(0,0,0,0.2)); }
        .start-btn-img:active { transform: scale(0.98) translateZ(0); }

        .guide-btn-start {
            position: absolute; bottom: 30px; left: 30px; width: 80px; cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            opacity: 0; animation: fadeInBtn 1s ease-out 0.6s forwards;
        }
        .guide-btn-start:hover { transform: scale(1.1) translateZ(0); }
        .guide-btn-start:active { transform: scale(0.95) translateZ(0); }

        .signature-container {
            position: absolute; bottom: 30px; right: 40px;
            display: flex; flex-direction: column; align-items: flex-end;
            opacity: 0; animation: fadeInBtn 1s ease-out 0.8s forwards; z-index: 1000;
        }
        .signature-logo {
            height: 48px; width: auto; display: block; opacity: 0.9;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1)); cursor: pointer; margin-right: 5px;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .signature-logo:hover { opacity: 1; transform: scale(1.05) translateZ(0); }
        
        .intro-chat-box {
            display: none; background-color: white; padding: 10px 16px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); margin-bottom: 10px;
            text-align: center; position: relative; 
            font-family: "cwTeXYen", sans-serif;
            /* [調整] 字體加大 0.9rem -> 1.05rem */
            font-size: 1.05rem; 
            color: #666; font-weight: bold; white-space: nowrap;
            animation: popInBubble 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .intro-chat-box::after {
            content: ''; position: absolute; bottom: -6px; right: 18px; width: 0; height: 0;
            border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid white;
        }
        .intro-chat-box.visible { display: block; }
        @keyframes popInBubble { from { opacity: 0; transform: translateY(10px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }

        /* --- 2. Main Board --- */
        #main-board {
            display: none; width: 100%; height: 100%;
            background-image: url('./board.png'); 
            background-size: cover; background-position: center calc(50% + 30px); 
            background-repeat: no-repeat; background-color: white;
            position: relative; opacity: 0; transition: opacity 1s ease;
        }
        @media (orientation: portrait) {
            #main-board {
                background-size: 100% auto !important; 
                background-position: center center !important; 
            }
        }

        .control-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 40px; z-index: 100;
        }
        .deck-btn {
            background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.5); border-radius: 40px;
            padding: 15px 40px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); font-weight: bold; color: #555;
            font-family: inherit;
            /* [調整] 字體加大 1.4rem -> 1.6rem */
            font-size: 1.6rem;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .deck-btn:hover {
            transform: translateY(-5px) translateZ(0); 
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
        }
        .deck-btn:active { transform: translateY(1px) translateZ(0); }

        .board-left-controls {
            position: absolute; bottom: 30px; left: 30px;
            z-index: 100; display: flex; gap: 20px; align-items: center;
        }
        .icon-btn { 
            width: 60px; height: 60px; cursor: pointer; 
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); opacity: 0.85; 
            transition: transform 0.2s ease, opacity 0.2s;
        }
        .icon-btn:hover { transform: scale(1.15) translateZ(0); opacity: 1; }
        .icon-btn:active { transform: scale(0.95) translateZ(0); }

        /* 垃圾桶樣式 */
        #trash-bin {
            position: absolute; bottom: 30px; right: 30px;
            z-index: 90; 
            width: 45px; 
            height: auto; 
            object-fit: contain; 
            transition: transform 0.2s ease, opacity 0.2s ease;
            cursor: pointer;
        }
        /* 垃圾桶互動效果 - 吞噬效果 */
        #trash-bin.drag-over {
            transform: scale(1.3) rotate(0deg) translateZ(0); 
            z-index: 2000; opacity: 0.7; 
            filter: drop-shadow(0 0 10px rgba(255, 80, 80, 0.5)); 
        }

        /* 垃圾桶提示氣泡 */
        #bin-bubble {
            display: none; position: absolute; bottom: 85px; right: 15px;
            background-color: white; padding: 8px 12px;
            border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            /* [調整] 字體加大 0.85rem -> 1.0rem */
            font-size: 1.0rem; 
            color: #666; font-weight: bold; white-space: nowrap;
            z-index: 95; pointer-events: none; 
            font-family: "cwTeXYen", sans-serif;
            animation: popInBubble 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #bin-bubble::after {
            content: ''; position: absolute; bottom: -6px; right: 20px; width: 0; height: 0;
            border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 6px solid white;
        }
        #bin-bubble.visible { display: block; }

        .reset-btn-svg {
            width: 45px; height: 45px; cursor: pointer;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); background: rgba(255, 255, 255, 0.9);
            border-radius: 50%; padding: 9px; box-sizing: border-box;
            transition: transform 0.4s ease;
        }
        .reset-btn-svg:hover { transform: rotate(-180deg) scale(1.15) translateZ(0); }
        .reset-btn-svg path { fill: #666; }

        .top-left-target {
            position: absolute; top: 15px; left: 30px; width: 50px; cursor: pointer;
            z-index: 200; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            transition: transform 0.2s ease;
        }
        .top-left-target:hover { transform: scale(1.15) translateZ(0); }

        .top-right-memo-btn {
            display: none; position: absolute; top: 30px; right: 30px; width: 80px;
            cursor: pointer; z-index: 150; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transition: transform 0.2s ease;
        }
        .top-right-memo-btn:hover { transform: scale(1.1) translateZ(0); }

        /* --- 3. Selection Overlay --- */
        #selection-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px);
            z-index: 2500; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.5s ease; flex-direction: column;
        }
        #overlay-title {
            font-size: 2rem; color: #555; margin-bottom: 5px; font-weight: 700;
            text-align: center; display: none; text-shadow: 0 2px 10px rgba(255,255,255,0.8);
        }
        
        .floating-container {
            display: grid; gap: 15px; padding: 20px; 
            width: 95%; max-height: 90vh; overflow-y: auto; box-sizing: border-box;
            transform: translateY(20px); transition: transform 0.5s ease;
        }
        /* 基礎/進階 - 3欄 x 2列 */
        .floating-container { grid-template-columns: repeat(3, 1fr); max-width: 750px; }

        /* [關鍵修正] 針對橫向手機及筆電 (Mobile Landscape + Laptops) -> 擴大保護範圍至 850px */
        @media (orientation: landscape) and (max-height: 850px) {
            .floating-container {
                max-width: 100vh; /* 寬度跟隨高度，保持 3x2 比例但不超過畫面 */
                padding: 5px; 
                gap: 10px;    
            }
        }

        /* 焦點模式 - 電腦/橫向 */
        .floating-container.focus-mode { 
            grid-template-columns: repeat(6, 1fr); gap: 15px; padding: 10px; max-width: 1100px;
        }
        /* 焦點模式 - 橫向手機/筆電修正 */
        @media (orientation: landscape) and (max-height: 850px) {
            .floating-container.focus-mode {
                max-width: 130vh; 
                gap: 5px;
            }
        }

        /* 焦點模式 - 直向 */
        @media (orientation: portrait) {
            .floating-container.focus-mode { grid-template-columns: repeat(4, 1fr); }
        }

        #selection-overlay.active .floating-container { transform: translateY(0); }
        
        .float-card { 
            width: 100%; padding: 5px; position: relative;
            transition: transform 0.2s ease; box-sizing: border-box;
            display: flex; justify-content: center; align-items: center;
        }
        .float-card:hover { transform: scale(1.05) translateZ(0); }
        .float-card img { width: 100%; height: auto; filter: drop-shadow(0 5px 15px rgba(0,0,0,0.1)); pointer-events: none; display: block; }
        .floating-container.focus-mode .float-card img { filter: drop-shadow(0 2px 5px rgba(0,0,0,0.08)); }
        .float-card.disabled { opacity: 0.3; filter: grayscale(100%); pointer-events: none; }

        /* --- 4. Modals --- */
        #detail-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 3000;
            flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.4s ease;
        }
        .modal-bg-click-area { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #large-card-img {
            max-height: 70vh; max-width: 90%; object-fit: contain;
            filter: drop-shadow(0 0 30px rgba(255,255,255,0.15));
            margin-bottom: 30px; z-index: 3001;
        }
        .modal-btn-group { display: flex; gap: 20px; z-index: 3001; }
        .action-btn {
            padding: 12px 50px; font-size: 1.2rem; border-radius: 50px;
            cursor: pointer; border: none; font-weight: bold; font-family: inherit;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .action-btn:hover { transform: scale(1.05) translateZ(0); }
        .action-btn:active { transform: scale(0.95) translateZ(0); }
        .btn-select { background-color: #8bc34a; color: white; box-shadow: 0 4px 15px rgba(139, 195, 74, 0.4); }

        /* --- 5. Placed Card --- */
        .placed-card {
            position: absolute; width: 180px;
            cursor: grab; transition: filter 0.2s; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2)); 
            touch-action: none; will-change: transform; 
        }
        .placed-card.dragging {
            cursor: grabbing; filter: drop-shadow(0 25px 40px rgba(0,0,0,0.3)); z-index: 1000;
        }
        .placed-card.target-focus {
            z-index: 100; width: 170px; cursor: default; 
            transition: all 1.5s cubic-bezier(0.22, 1, 0.36, 1); 
        }

        /* [關鍵修正] 焦點卡在橫向模式下的高度限制，避免擋住背景 */
        /* 適用於 iPhone 橫向 & Lenovo 筆電等扁螢幕 */
        @media (orientation: landscape) {
            .placed-card.target-focus {
                /* 嘗試保持 170px 寬，但如果高度超過螢幕 60%，就強制縮小 */
                width: auto;
                max-width: 170px;
                max-height: 60vh;
            }
        }

        /* --- 6. Memo --- */
        .smart-memo {
            position: absolute; width: 300px; height: 300px; z-index: 800;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.15)); animation: popIn 0.4s ease; cursor: grab; will-change: transform;
        }
        .smart-memo.dragging {
            z-index: 1100; filter: drop-shadow(0 20px 30px rgba(0,0,0,0.2)); transform: scale(1.05); cursor: grabbing;
        }
        .memo-bg-img { width: 100%; height: auto; pointer-events: none; display: block; opacity: 0.85; }
        .memo-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; touch-action: none; pointer-events: none; z-index: 5; }
        .memo-textarea {
            position: absolute; top: 70px; left: 35px; width: calc(100% - 70px); height: calc(100% - 110px);
            background: transparent; border: none; resize: none; outline: none;
            /* [修改] 這裡也統一使用 cwTeXYen，或者您想保留標楷體手寫感也可以，這裡我先幫您統一 */
            font-family: "cwTeXYen", "BiauKai", "KaiTi", "DFKai-SB", serif;
            /* [調整] 字體加大 1.4rem -> 1.8rem */
            font-size: 1.8rem; 
            color: #333; line-height: 1.6; display: block; pointer-events: none; box-sizing: border-box; z-index: 10;
        }
        .memo-textarea.hide-placeholder::placeholder { color: transparent; }
        .memo-tools {
            position: absolute; top: 8px; right: 8px; display: flex; gap: 6px; opacity: 0.6; transition: opacity 0.2s; z-index: 12;
        }
        .smart-memo:hover .memo-tools { opacity: 1; }
        .tool-btn {
            width: 30px; height: 30px; border-radius: 50%; background: rgba(255,255,255,0.9);
            border: 1px solid #ddd; cursor: pointer; font-size: 16px;
            display: flex; justify-content: center; align-items: center; transition: transform 0.2s ease;
        }
        .tool-btn:hover { background: #fff; transform: scale(1.15) translateZ(0); }
        .tool-btn.active { background: #4fc3f7; color: white; border-color: #4fc3f7; }
        
        /* --- Other Modals --- */
        #guide-modal, #custom-confirm-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 3000;
            flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.6s ease;
        }
        #custom-confirm-modal { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(8px); z-index: 3500; }
        #guide-content-wrapper {
            position: relative; transform: scale(0.95); transition: transform 0.6s ease;
            display: flex; justify-content: center; align-items: center; width: 100%; max-width: 1200px;
        }
        #guide-modal.active, #custom-confirm-modal.active { opacity: 1; }
        #guide-modal.active #guide-content-wrapper, #custom-confirm-modal.active .confirm-box { transform: scale(1); }
        #guide-image { max-width: 80%; max-height: 85vh; object-fit: contain; border-radius: 10px; transition: opacity 0.3s; opacity: 1; }
        #guide-image.fade-out { opacity: 0; }
        .guide-nav-btn {
            background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 50%;
            width: 60px; height: 60px; cursor: pointer; position: absolute;
            display: flex; justify-content: center; align-items: center; transition: transform 0.2s ease, background 0.2s;
        }
        .guide-nav-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1) translateZ(0); }
        .guide-nav-btn.left { left: 20px; } .guide-nav-btn.right { right: 20px; }
        .guide-nav-btn svg { width: 30px; height: 30px; fill: white; }
        #guide-page-num { position: absolute; bottom: -40px; color: white; font-weight: bold; font-size: 1.2rem; }
        
        .confirm-box { background: rgba(255, 255, 255, 0.9); padding: 30px 50px; border-radius: 20px; text-align: center; transform: scale(0.9); transition: transform 0.3s; max-width: 400px; }
        .confirm-msg { 
            /* [調整] 字體加大 1.3rem -> 1.6rem */
            font-size: 1.6rem; 
            color: #555; margin-bottom: 30px; font-weight: bold; 
        }
        .confirm-actions { display: flex; gap: 20px; justify-content: center; }
        .confirm-btn { 
            padding: 10px 30px; border-radius: 30px; border: none; 
            /* [調整] 字體加大 1rem -> 1.2rem */
            font-size: 1.2rem; 
            cursor: pointer; font-weight: bold; transition: transform 0.2s ease; 
        }
        .confirm-btn:hover { transform: scale(1.05) translateZ(0); }
        .btn-yes { background: #ff8a80; color: white; } .btn-no { background: #e0e0e0; color: #555; }

    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="loader"></div>
        <div class="loading-text">載入中...</div>
    </div>

    <div id="silent-preload" style="display: none;">
        <img src="./Memo_1.png" alt="">
        <img src="./Memo_2.png" alt="">
        <img src="./Memo_3.png" alt="">
        <img src="./Memo_4.png" alt="">
        <img src="./bin.png" alt="">
        <img src="./Guide_2.png" alt="">
        <img src="./Guide_3.png" alt="">
    </div>

    <div id="scalable-wrapper">
        <div id="start-screen">
            <div class="instruction-text">
                請根據你的感受，將圖卡由左至右排列：<br>
                由<span class="highlight-blue">最放鬆或最開心</span>至令你感到<span class="highlight-grey">緊張或有壓力</span>。<br>
                次序並無對錯，只需依照你真實的感受。
            </div>
            <img src="./Start.png" class="start-btn-img" onclick="enterBoard()" alt="Start">
            <img src="./Guide_button.png" class="guide-btn-start" onclick="openGuide()" alt="Guide">
            <div class="signature-container">
                <div class="intro-chat-box" id="intro-bubble">本平台由教育心理學家設計</div>
                <img src="./sign.png" alt="Signature" class="signature-logo" onclick="toggleIntroBubble(event)">
            </div>
        </div>

        <div id="main-board">
            <img src="./Target.png" class="top-left-target" onclick="triggerFocusSelection()" alt="Target" title="選擇焦點卡">
            <img src="./Memo_0.png" class="top-right-memo-btn" id="memo-trigger-btn" onclick="spawnSmartMemo()" alt="Memo" title="新增便利貼">
            
            <div id="bin-bubble">拖放至此刪除</div>
            
            <img src="./bin.png" id="trash-bin" alt="Trash Bin" title="拖放到此刪除">

            <div class="board-left-controls">
                <img src="./Return.png" class="icon-btn" onclick="askReturnHome()" alt="Return" title="返回首頁">
                <svg class="reset-btn-svg" viewBox="0 0 24 24" onclick="askResetBoard()" title="清空桌面">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
            </div>
            <div class="control-bar">
                <button class="deck-btn" onclick="showDeck('basic')">基礎卡</button>
                <button class="deck-btn" onclick="showDeck('advanced')">進階卡</button>
            </div>
        </div>
    </div> 

    <div id="selection-overlay" onclick="closeOverlay(event)">
        <div id="overlay-title">確認焦點圖卡作延伸探討</div>
        <div class="floating-container" id="floating-container"></div>
    </div>
    <div id="detail-modal">
        <div class="modal-bg-click-area" onclick="closeModal()"></div>
        <img id="large-card-img" src="" alt="Card Detail" onclick="event.stopPropagation()">
        <div class="modal-btn-group">
            <button class="action-btn btn-select" onclick="confirmSelect()">選擇這張</button>
        </div>
    </div>
    <div id="guide-modal" onclick="closeGuideBackground(event)">
        <div id="guide-content-wrapper">
            <div class="guide-nav-btn left" onclick="changeGuide(-1)"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></div>
            <img id="guide-image" src="" alt="Guide Page">
            <div class="guide-nav-btn right" onclick="changeGuide(1)"><svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>
            <span id="guide-page-num">1 / 3</span>
        </div>
    </div>
    <div id="custom-confirm-modal" onclick="closeConfirmBackground(event)">
        <div class="confirm-box">
            <div class="confirm-msg" id="confirm-text">...</div>
            <div class="confirm-actions">
                <button class="confirm-btn btn-no" onclick="closeConfirm()">取消</button>
                <button class="confirm-btn btn-yes" id="confirm-yes-btn">確定</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global Scale Variable ---
        let currentScale = 1;

        // --- Constants ---
        const cards = { basic: [1,2,3,4,5,6], advanced: [7,8,9,10,11,12] };
        
        // --- 預載圖片列表 ---
        const imagesToPreload = [
            'board.png', 'Start.png', 'Guide_button.png', 'sign.png',
            'Target.png', 'Memo_0.png', 'Return.png', 'bin.png',
            'Guide_1.png' 
        ];
        for(let i=1; i<=12; i++) imagesToPreload.push(`card_${i}.png`);

        let placedCardIds = new Set();
        let currentSelectedCardId = null;
        let currentGuidePage = 1;
        const totalGuidePages = 3;
        let onConfirmAction = null;
        let isSelectingFocus = false; 
        let memoCounter = 1;
        let nextRotationDir = 1; 

        // --- Initialization ---
        window.onload = function() {
            preloadImages();
            resizeBoard(); 
            window.addEventListener('resize', resizeBoard);
            setupBinEvents();
        };

        // --- Bin Events (Chat Box) ---
        function setupBinEvents() {
            const bin = document.getElementById('trash-bin');
            const bubble = document.getElementById('bin-bubble');
            
            // Mouse Hover (Desktop)
            bin.addEventListener('pointerenter', () => bubble.classList.add('visible'));
            bin.addEventListener('pointerleave', () => bubble.classList.remove('visible'));
            
            // Click/Touch (Mobile)
            bin.addEventListener('click', (e) => {
                e.stopPropagation();
                bubble.classList.add('visible');
                setTimeout(() => bubble.classList.remove('visible'), 2000);
            });
        }

        // --- Global Scaler ---
        function resizeBoard() {
            const baseWidth = 1280;
            const screenWidth = window.innerWidth;
            let scale = screenWidth / baseWidth;
            if (scale > 1) scale = 1; 
            currentScale = scale;
            
            const wrapper = document.getElementById('scalable-wrapper');
            wrapper.style.transform = `scale(${currentScale})`;
            wrapper.style.width = `${100 / currentScale}%`;
            wrapper.style.height = `${100 / currentScale}%`;
        }

        // --- Safety Preloader (3s Timeout) ---
        function preloadImages() {
            let loadedCount = 0;
            const total = imagesToPreload.length;
            let isDone = false; 

            const safetyTimer = setTimeout(() => {
                if (!isDone) {
                    console.log("Preload timed out, forcing start.");
                    finishLoading();
                }
            }, 3000);

            if(total === 0) {
                finishLoading();
                clearTimeout(safetyTimer);
                return;
            }

            const checkDone = () => {
                loadedCount++;
                if (loadedCount === total && !isDone) {
                    isDone = true;
                    clearTimeout(safetyTimer);
                    finishLoading();
                }
            };

            imagesToPreload.forEach(src => {
                const img = new Image();
                img.src = `./${src}`;
                img.onload = checkDone;
                img.onerror = checkDone; 
            });
        }

        function finishLoading() {
            const loadingScreen = document.getElementById('loading-screen');
            const startScreen = document.getElementById('start-screen');
            document.getElementById('guide-image').src = './Guide_1.png';
            
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                startScreen.style.display = 'flex';
                setTimeout(() => startScreen.style.opacity = '1', 50);
            }, 500);
        }

        // --- Anti-Ghosting & Events ---
        document.addEventListener('dragstart', function(e) { e.preventDefault(); }); 
        
        document.addEventListener('touchstart', function(e) {
            if (e.target.tagName === 'IMG' && !e.target.classList.contains('start-btn-img') && !e.target.parentElement.classList.contains('deck-btn')) {
                // Do not preventDefault to allow click
            }
            if (!e.target.closest('.signature-logo')) {
                const bubble = document.getElementById('intro-bubble');
                if(bubble) bubble.classList.remove('visible');
            }
        }, {passive: false});

        document.addEventListener('click', (e) => {
            const bubble = document.getElementById('intro-bubble');
            if (bubble && bubble.classList.contains('visible') && !e.target.closest('.signature-logo') && !e.target.closest('#intro-bubble')) {
                bubble.classList.remove('visible');
            }
        });

        document.addEventListener('pointerdown', (e) => {
            if(e.target.closest('.tool-btn')) return;
            const clickedMemo = e.target.closest('.smart-memo');
            const allMemos = document.querySelectorAll('.smart-memo');
            allMemos.forEach(memo => {
                if(memo !== clickedMemo) resetMemoToMoveMode(memo);
            });
        });

        // --- Keyboard Controls ---
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const bubble = document.getElementById('intro-bubble');
                if (bubble && bubble.classList.contains('visible')) bubble.classList.remove('visible');

                const detailModal = document.getElementById('detail-modal');
                if (detailModal.style.display === 'flex') closeModal();
                
                const guideModal = document.getElementById('guide-modal');
                if (guideModal.style.display === 'flex') closeGuide();
                
                const overlay = document.getElementById('selection-overlay');
                if (overlay.style.display === 'flex') {
                    overlay.style.opacity = '0';
                    overlay.classList.remove('active');
                    setTimeout(() => overlay.style.display = 'none', 500);
                }
                const confirmModal = document.getElementById('custom-confirm-modal');
                if(confirmModal.style.display === 'flex') closeConfirm();
            }
            
            const guideModal = document.getElementById('guide-modal');
            if (guideModal.style.display === 'flex') {
                if (e.key === 'ArrowLeft') changeGuide(-1);
                if (e.key === 'ArrowRight') changeGuide(1);
            }
        });

        // --- Functions ---
        function toggleIntroBubble(e) {
            e.stopPropagation(); 
            const bubble = document.getElementById('intro-bubble');
            bubble.classList.toggle('visible');
        }

        function enterBoard() {
            document.getElementById('start-screen').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('start-screen').style.display = 'none';
                const board = document.getElementById('main-board');
                board.style.display = 'block';
                requestAnimationFrame(() => board.style.opacity = '1');
            }, 1000);
        }

        function openGuide() {
            currentGuidePage = 1; updateGuideImage();
            const modal = document.getElementById('guide-modal');
            modal.style.display = 'flex';
            requestAnimationFrame(() => modal.classList.add('active'));
        }
        function closeGuideBackground(e) { 
            if (e.target.id === 'guide-modal' || e.target.id === 'guide-content-wrapper') closeGuide(); 
        }
        function closeGuide() {
            const modal = document.getElementById('guide-modal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 600);
        }
        function changeGuide(dir) {
            const next = currentGuidePage + dir;
            if (next < 1 || next > totalGuidePages) return;
            const img = document.getElementById('guide-image');
            img.classList.add('fade-out');
            setTimeout(() => {
                currentGuidePage = next; updateGuideImage();
                img.onload = () => img.classList.remove('fade-out');
                setTimeout(() => img.classList.remove('fade-out'), 50);
            }, 300);
        }
        function updateGuideImage() {
            document.getElementById('guide-image').src = `./Guide_${currentGuidePage}.png`;
            document.getElementById('guide-page-num').innerText = `${currentGuidePage} / ${totalGuidePages}`;
        }

        function showConfirm(msg, cb) {
            document.getElementById('confirm-text').innerHTML = msg;
            onConfirmAction = cb;
            const modal = document.getElementById('custom-confirm-modal');
            modal.style.display = 'flex';
            requestAnimationFrame(() => modal.classList.add('active'));
            document.getElementById('confirm-yes-btn').onclick = () => {
                if (onConfirmAction) onConfirmAction(); closeConfirm();
            };
        }
        
        function closeConfirmBackground(e) {
            if (e.target.id === 'custom-confirm-modal') {
                closeConfirm();
            }
        }
        
        function closeConfirm() {
            const modal = document.getElementById('custom-confirm-modal');
            modal.classList.remove('active');
            setTimeout(() => { modal.style.display = 'none'; onConfirmAction = null; }, 300);
        }
        function askReturnHome() { showConfirm("確定要返回首頁嗎？<br>目前的卡片排列將會重置。", () => location.reload()); }
        function askResetBoard() {
            const board = document.getElementById('main-board');
            if(placedCardIds.size === 0 && !board.querySelector('.smart-memo')) return;
            showConfirm("確定要清空桌面上的<br>所有卡片和便利貼嗎？", () => {
                placedCardIds.clear();
                board.querySelectorAll('.placed-card, .smart-memo, .memo-box').forEach(el => el.remove());
                document.getElementById('memo-trigger-btn').style.display = 'none';
                document.querySelector('.control-bar').style.display = 'flex';
            });
        }

        // --- Card Interaction Logic ---
        function showDeck(type) {
            isSelectingFocus = false; 
            document.getElementById('overlay-title').style.display = 'none';
            openSelectionOverlay(cards[type]);
        }
        function triggerFocusSelection() {
            isSelectingFocus = true; 
            document.getElementById('overlay-title').style.display = 'block';
            openSelectionOverlay([...cards.basic, ...cards.advanced]);
        }

        function openSelectionOverlay(ids) {
            const overlay = document.getElementById('selection-overlay');
            const container = document.getElementById('floating-container');
            container.innerHTML = ''; 
            container.className = isSelectingFocus ? 'floating-container focus-mode' : 'floating-container';
            
            ids.forEach(num => {
                const div = document.createElement('div');
                div.className = 'float-card';
                if (placedCardIds.has(num) && !isSelectingFocus) { 
                    div.classList.add('disabled'); 
                    div.innerHTML = `<img src="./card_${num}.png" alt="Used">`;
                } else {
                    div.innerHTML = `<img src="./card_${num}.png" alt="Card ${num}">`;
                    div.onpointerdown = (e) => handleDeckInteraction(e, num, div);
                }
                container.appendChild(div);
            });
            overlay.style.display = 'flex';
            requestAnimationFrame(() => { overlay.style.opacity = '1'; overlay.classList.add('active'); });
        }

        function handleDeckInteraction(e, num, cardEl) {
            e.preventDefault(); 
            const startX = e.clientX;
            const startY = e.clientY;
            let hasMoved = false;

            const rect = cardEl.getBoundingClientRect();
            const relX = (startX - rect.left) / rect.width;
            const relY = (startY - rect.top) / rect.height;

            const onMove = (ev) => {
                if (Math.hypot(ev.clientX - startX, ev.clientY - startY) > 10) {
                    hasMoved = true;
                    closeOverlayDirectly();
                    
                    if (isSelectingFocus) spawnFocusCard(num, ev.clientX, ev.clientY);
                    else spawnCardOnBoard(num, ev.clientX, ev.clientY, relX, relY, true);
                    
                    cleanup();
                }
            };
            
            const onUp = (ev) => {
                if (!hasMoved) {
                    ev.stopPropagation(); 
                    openDetail(num);
                }
                cleanup();
            };

            const cleanup = () => {
                document.removeEventListener('pointermove', onMove);
                document.removeEventListener('pointerup', onUp);
            };

            document.addEventListener('pointermove', onMove);
            document.addEventListener('pointerup', onUp);
        }

        function closeOverlayDirectly() {
            const overlay = document.getElementById('selection-overlay');
            overlay.style.display = 'none'; overlay.style.opacity = '0'; overlay.classList.remove('active');
        }
        function closeOverlay(e) {
            if(e.target.id === 'selection-overlay') {
                const overlay = document.getElementById('selection-overlay');
                overlay.style.opacity = '0'; overlay.classList.remove('active');
                setTimeout(() => overlay.style.display = 'none', 500);
            }
        }
        function openDetail(num) {
            currentSelectedCardId = num;
            const modal = document.getElementById('detail-modal');
            const img = document.getElementById('large-card-img');
            img.src = `./card_${num}.png`;
            modal.style.display = 'flex';
            requestAnimationFrame(() => { modal.style.opacity = '1'; img.style.transform = 'scale(1)'; });
        }
        function closeModal() {
            const modal = document.getElementById('detail-modal');
            const img = document.getElementById('large-card-img');
            modal.style.opacity = '0'; img.style.transform = 'scale(0.9)';
            setTimeout(() => modal.style.display = 'none', 300);
        }
        function confirmSelect() {
            closeModal(); closeOverlayDirectly();
            if (isSelectingFocus) spawnFocusCard(currentSelectedCardId);
            else spawnCardOnBoard(currentSelectedCardId);
        }

        function spawnFocusCard(num, clientX, clientY) {
            const board = document.getElementById('main-board');
            board.querySelectorAll('.placed-card').forEach(c => c.remove());
            placedCardIds.clear(); placedCardIds.add(num);

            const newCard = document.createElement('img');
            newCard.src = `./card_${num}.png`;
            newCard.className = 'placed-card target-focus';
            newCard.dataset.angle = 0;
            // [新增] 存入 ID 以便刪除時識別
            newCard.dataset.cardId = num; 
            
            if (clientX && clientY) {
                const wrapperRect = document.getElementById('scalable-wrapper').getBoundingClientRect();
                const x = (clientX - wrapperRect.left) / currentScale;
                const y = (clientY - wrapperRect.top) / currentScale;
                newCard.style.left = (x - 75) + 'px'; 
                newCard.style.top = (y - 75) + 'px';
            } else {
                newCard.style.left = '50%'; newCard.style.top = '50%';
                newCard.style.transform = 'translate(-50%, -50%) scale(1.1)';
            }
            
            board.appendChild(newCard);
            requestAnimationFrame(() => {
                setTimeout(() => {
                    newCard.style.left = '45px'; newCard.style.top = '25px';
                    newCard.style.transform = 'translate(0,0) scale(1)';
                }, 50);
            });
            document.getElementById('memo-trigger-btn').style.display = 'block';
            document.querySelector('.control-bar').style.display = 'none';
        }

        // --- Spawn with Percentage Offset ---
        function spawnCardOnBoard(num, clientX, clientY, relX, relY, immediateDrag) {
            placedCardIds.add(num);
            const board = document.getElementById('main-board');
            const newCard = document.createElement('img');
            newCard.src = `./card_${num}.png`;
            newCard.className = 'placed-card';
            // [新增] 存入 ID
            newCard.dataset.cardId = num;
            
            const magnitude = 0.5 + Math.random() * 3.0; 
            const angle = magnitude * nextRotationDir;
            nextRotationDir *= -1; 
            newCard.dataset.angle = angle;

            if (immediateDrag && clientX) {
                board.appendChild(newCard);
                const finalWidth = newCard.offsetWidth;
                const finalHeight = newCard.offsetHeight;
                
                const wrapperRect = document.getElementById('scalable-wrapper').getBoundingClientRect();
                const boardMouseX = (clientX - wrapperRect.left) / currentScale;
                const boardMouseY = (clientY - wrapperRect.top) / currentScale;
                
                newCard.style.left = (boardMouseX - finalWidth * relX) + 'px';
                newCard.style.top = (boardMouseY - finalHeight * relY) + 'px';
            } else {
                board.appendChild(newCard);
                newCard.style.left = (1280/2 - 80 + Math.random()*40 - 20) + 'px';
                newCard.style.top = (window.innerHeight/currentScale/2 - 100) + 'px';
            }
            
            newCard.style.transform = `rotate(${angle}deg) scale(1)`;
            makeDraggable(newCard);
            
            if (immediateDrag) {
                newCard.classList.add('dragging');
                newCard.style.transform = `rotate(${angle}deg) scale(1.15)`;
                const startLeft = parseFloat(newCard.style.left);
                const startTop = parseFloat(newCard.style.top);
                startDragProcess(newCard, startLeft, startTop, clientX, clientY);
            }
        }

        function makeDraggable(elmnt) {
            elmnt.onpointerdown = (e) => {
                e.preventDefault();
                const startLeft = elmnt.offsetLeft;
                const startTop = elmnt.offsetTop;
                const startX = e.clientX;
                const startY = e.clientY;
                elmnt.classList.add('dragging');
                const angle = elmnt.dataset.angle || 0;
                elmnt.style.transform = `rotate(${angle}deg) scale(1.15)`;
                startDragProcess(elmnt, startLeft, startTop, startX, startY);
            };
        }
        
        function makeDraggableMemo(elmnt) {
            elmnt.onpointerdown = (e) => {
                if(e.target.classList.contains('tool-btn') || e.target.classList.contains('memo-close') || 
                   (e.target.tagName==='TEXTAREA'&&getComputedStyle(e.target).pointerEvents==='auto') ||
                   (e.target.tagName==='CANVAS'&&getComputedStyle(e.target).pointerEvents==='auto')) return;
                
                e.preventDefault();
                const startLeft = elmnt.offsetLeft;
                const startTop = elmnt.offsetTop;
                const startX = e.clientX;
                const startY = e.clientY;
                elmnt.classList.add('dragging');
                
                const onMove = (ev) => {
                    ev.preventDefault();
                    const deltaX = (ev.clientX - startX) / currentScale;
                    const deltaY = (ev.clientY - startY) / currentScale;
                    elmnt.style.left = (startLeft + deltaX) + 'px';
                    elmnt.style.top = (startTop + deltaY) + 'px';
                };
                const onUp = () => {
                    elmnt.classList.remove('dragging');
                    document.removeEventListener('pointermove', onMove);
                    document.removeEventListener('pointerup', onUp);
                };
                // 這裡使用 startDragProcess 來統一處理垃圾桶互動
                startDragProcess(elmnt, startLeft, startTop, startX, startY);
            };
        }

        // [核心修改] 垃圾桶互動邏輯 - 分別處理卡片和便利貼
        function startDragProcess(elmnt, startLeft, startTop, startMouseX, startMouseY) {
            const trashBin = document.getElementById('trash-bin');

            const onMove = (e) => {
                e.preventDefault();
                const deltaX = (e.clientX - startMouseX) / currentScale;
                const deltaY = (e.clientY - startMouseY) / currentScale;
                elmnt.style.left = (startLeft + deltaX) + 'px';
                elmnt.style.top = (startTop + deltaY) + 'px';

                // 碰撞檢測 (Collision Detection)
                const binRect = trashBin.getBoundingClientRect();
                const elemRect = elmnt.getBoundingClientRect();
                let isOver = false;

                // [核心調整]：區分卡片和便利貼
                if (elmnt.classList.contains('smart-memo')) {
                    // 便利貼：內縮 30px (安全邊緣)
                    const offset = 30; 
                    const memoCore = {
                        left: elemRect.left + offset,
                        right: elemRect.right - offset,
                        top: elemRect.top + offset,
                        bottom: elemRect.bottom - offset
                    };
                    
                    isOver = !(memoCore.right < binRect.left || 
                               memoCore.left > binRect.right || 
                               memoCore.bottom < binRect.top || 
                               memoCore.top > binRect.bottom);
                } else {
                    // 卡片：維持邊緣接觸 (Edge Touch)
                    isOver = !(elemRect.right < binRect.left || 
                               elemRect.left > binRect.right || 
                               elemRect.bottom < binRect.top || 
                               elemRect.top > binRect.bottom);
                }

                if (isOver) trashBin.classList.add('drag-over');
                else trashBin.classList.remove('drag-over');
            };

            const onUp = () => {
                elmnt.classList.remove('dragging');
                // 如果是卡片，恢復角度
                if (elmnt.classList.contains('placed-card')) {
                    const angle = elmnt.dataset.angle || 0;
                    elmnt.style.transform = `rotate(${angle}deg) scale(1)`;
                } else if (elmnt.classList.contains('smart-memo')) {
                    // 如果是 memo，不恢復縮放 (因原本就無縮放)
                }

                // 檢查是否在垃圾桶上
                if (trashBin.classList.contains('drag-over')) {
                    // 刪除邏輯
                    if (elmnt.classList.contains('placed-card')) {
                        const id = parseInt(elmnt.dataset.cardId);
                        if (id) placedCardIds.delete(id);
                        
                        // 如果刪除了焦點卡，恢復控制列顯示
                        if (elmnt.classList.contains('target-focus')) {
                            document.getElementById('memo-trigger-btn').style.display = 'none';
                            document.querySelector('.control-bar').style.display = 'flex';
                        }
                    }
                    elmnt.remove();
                    trashBin.classList.remove('drag-over');
                }

                document.removeEventListener('pointermove', onMove);
                document.removeEventListener('pointerup', onUp);
            };

            document.addEventListener('pointermove', onMove);
            document.addEventListener('pointerup', onUp);
        }

        // --- Memo & Canvas Logic ---
        function initSmartMemo(container) {
            const canvas = container.querySelector('.memo-canvas');
            const rect = container.getBoundingClientRect();
            canvas.width = 300; canvas.height = 300;
            makeDraggableMemo(container);
            initCanvasDraw(canvas);
        }
        function spawnSmartMemo() {
            const board = document.getElementById('main-board');
            const memoId = `memo-${Date.now()}`;
            const container = document.createElement('div');
            container.className = 'smart-memo'; container.id = memoId;
            container.style.left = (1280 / 2 + Math.random()*50) + 'px';
            container.style.top = (window.innerHeight/currentScale / 2 - 150) + 'px';

            const bgSrc = `./Memo_${memoCounter}.png`;
            memoCounter = memoCounter >= 4 ? 1 : memoCounter + 1;

            container.innerHTML = `
                <div class="memo-tools">
                    <div class="tool-btn" onclick="toggleMemoMode('${memoId}','draw')">✏️</div>
                    <div class="tool-btn" onclick="toggleMemoMode('${memoId}','type')">⌨️</div>
                    <div class="tool-btn" onclick="clearMemoContent('${memoId}')">🗑️</div>
                </div>
                <img src="${bgSrc}" class="memo-bg-img">
                <canvas class="memo-canvas"></canvas>
                <textarea class="memo-textarea"></textarea>
            `;
            board.appendChild(container);
            initSmartMemo(container);
        }
        function resetMemoToMoveMode(container) {
            const canvas = container.querySelector('.memo-canvas');
            const textarea = container.querySelector('.memo-textarea');
            const btns = container.querySelectorAll('.tool-btn');
            canvas.style.pointerEvents = 'none'; textarea.style.pointerEvents = 'none';
            textarea.classList.remove('hide-placeholder'); btns.forEach(b => b.classList.remove('active'));
        }
        function clearMemoContent(id) {
            const c = document.getElementById(id);
            c.querySelector('.memo-canvas').getContext('2d').clearRect(0,0,300,300);
            c.querySelector('.memo-textarea').value = '';
        }
        function toggleMemoMode(id, mode) {
            const c = document.getElementById(id);
            const canvas = c.querySelector('.memo-canvas');
            const text = c.querySelector('.memo-textarea');
            const btns = c.querySelectorAll('.tool-btn');
            if(mode==='draw') {
                if(btns[0].classList.contains('active')) {
                    canvas.style.pointerEvents='none'; text.classList.remove('hide-placeholder'); btns[0].classList.remove('active');
                } else {
                    canvas.style.pointerEvents='auto'; text.style.pointerEvents='none'; text.classList.add('hide-placeholder');
                    btns[0].classList.add('active'); btns[1].classList.remove('active');
                }
            } else {
                if(btns[1].classList.contains('active')) {
                    text.style.pointerEvents='none'; btns[1].classList.remove('active');
                } else {
                    canvas.style.pointerEvents='none'; text.style.pointerEvents='auto'; text.classList.remove('hide-placeholder');
                    text.focus(); btns[0].classList.remove('active'); btns[1].classList.add('active');
                }
            }
        }
        function initCanvasDraw(canvas) {
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.lineCap = "round";
            let isDrawing = false;
            
            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                const relX = (clientX - rect.left) / rect.width;
                const relY = (clientY - rect.top) / rect.height;
                return { x: relX * canvas.width, y: relY * canvas.height };
            }

            function start(e) {
                if(getComputedStyle(canvas).pointerEvents==='none') return;
                isDrawing = true; ctx.beginPath();
                const p = getPos(e); ctx.moveTo(p.x, p.y);
            }
            function move(e) {
                if(!isDrawing) return;
                if(e.type==='touchmove') e.preventDefault();
                const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke();
            }
            function end() { isDrawing = false; }

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', start, {passive:false});
            canvas.addEventListener('touchmove', move, {passive:false});
            canvas.addEventListener('touchend', end);
        }
    </script>
</body>
</html>